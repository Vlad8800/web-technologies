const authSection = document.getElementById('auth-section');
const searchSection = document.getElementById('search-section');
const userPanel = document.getElementById('user-panel');
const usersContainer = document.getElementById('users');
const searchInput = document.getElementById('search');
const sortSelect = document.getElementById('sort');
const filterAge = document.getElementById('filter-age');
const filterLocation = document.getElementById('filter-location');
const pagination = document.getElementById('pagination');
const favoritesSection = document.getElementById('favorites-section');
const favoritesUsers = document.getElementById('favorites-users');

let allUsers = [], filteredUsers = [], currentPage = 1, usersPerPage = 30;
const countries = ['–£–∫—Ä–∞—ó–Ω–∞', '–ü–æ–ª—å—â–∞', '–ù—ñ–º–µ—á—á–∏–Ω–∞', '–§—Ä–∞–Ω—Ü—ñ—è'];
const cities = {
 '–£–∫—Ä–∞—ó–Ω–∞': ['–ö–∏—ó–≤', '–õ—å–≤—ñ–≤', '–û–¥–µ—Å–∞'],
 '–ü–æ–ª—å—â–∞': ['–í–∞—Ä—à–∞–≤–∞', '–ö—Ä–∞–∫—ñ–≤', '–ì–¥–∞–Ω—Å—å–∫'],
 '–ù—ñ–º–µ—á—á–∏–Ω–∞': ['–ë–µ—Ä–ª—ñ–Ω', '–ú—é–Ω—Ö–µ–Ω', '–ì–∞–º–±—É—Ä–≥'],
 '–§—Ä–∞–Ω—Ü—ñ—è': ['–ü–∞—Ä–∏–∂', '–õ—ñ–æ–Ω', '–ú–∞—Ä—Å–µ–ª—å']
};

const debounce = (fn, delay) => {
 let timeout;
 return (...args) => {
  clearTimeout(timeout);
  timeout = setTimeout(() => fn(...args), delay);
 };
};

const validateField = (field, condition, errorMessage, emptyMessage) => {
 const errorDiv = field.nextElementSibling?.classList.contains('error-message') ? field.nextElementSibling : field.parentElement.nextElementSibling;
 if (!condition()) {
  field.classList.remove('valid');
  field.classList.add('invalid');
  field.setAttribute('aria-invalid', 'true');
  errorDiv.textContent = errorMessage;
  return false;
 } else {
  field.classList.remove('invalid');
  field.classList.add('valid');
  field.setAttribute('aria-invalid', 'false');
  errorDiv.textContent = '';
  return true;
 }
};

const showSuccessMessage = (message) => {
 const div = document.createElement('div');
 div.className = 'success-message';
 div.textContent = message;
 document.body.appendChild(div);
 setTimeout(() => div.remove(), 3000);
};

window.showForm = (formId) => {
 document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
 document.querySelector(`[onclick="showForm('${formId}')"]`).classList.add('active');
 document.querySelectorAll('form').forEach(form => form.classList.add('hidden'));
 const activeForm = document.getElementById(formId);
 activeForm.classList.remove('hidden');
 activeForm.querySelector('input, select').focus();
};

const renderAuth = () => {
 const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
 if (currentUser) {
  authSection.classList.add('hidden');
  searchSection.classList.remove('hidden');
  userPanel.innerHTML = `
   <button class="favorites-btn" onclick="showFavorites()" aria-label="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –æ–±—Ä–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –æ–±—Ä–∞–Ω–∏—Ö</button>
   <button onclick="logout()" aria-label="–í–∏–π—Ç–∏ –∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É">–í–∏–π—Ç–∏ (${currentUser})</button>
  `;
  fetchUsers();
  updateURL();
  return;
 }

 authSection.innerHTML = `

  <form id="login-form" aria-labelledby="login-title">
      <div class="tab-buttons">
   <button class="tab active" onclick="showForm('login-form')" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ñ–æ—Ä–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</button>
   <button class="tab" onclick="showForm('register-form')" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ñ–æ—Ä–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
  </div>
   <h3 id="login-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h3>
   <input type="text" id="login-username" placeholder="–Ü–º'—è" required aria-label="–Ü–º'—è" aria-describedby="login-username-error" />
   <div class="error-message" id="login-username-error"></div>
   <div class="password-toggle">
    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required aria-label="–ü–∞—Ä–æ–ª—å" aria-describedby="login-password-error" />
    <span id="toggle-login" role="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç–∏ –∞–±–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å">üëÅ</span>
   </div>
   <div class="error-message" id="login-password-error"></div>
   <label><input type="checkbox" id="remember-me" aria-label="–ó–∞–ø–∞–º‚Äô—è—Ç–∞—Ç–∏ –º–µ–Ω–µ" /> –ó–∞–ø–∞–º‚Äô—è—Ç–∞—Ç–∏ –º–µ–Ω–µ</label>
   <button type="submit" aria-label="–£–≤—ñ–π—Ç–∏">–£–≤—ñ–π—Ç–∏</button>
  </form>
  <form id="register-form" class="hidden" novalidate aria-labelledby="register-title">
      <div class="tab-buttons">
   <button class="tab active" onclick="showForm('login-form')" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ñ–æ—Ä–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</button>
   <button class="tab" onclick="showForm('register-form')" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ñ–æ—Ä–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
  </div>
   <h3 id="register-title">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
   <input type="text" id="first-name" placeholder="–Ü–º'—è" required aria-label="–Ü–º'—è" aria-describedby="first-name-error" />
   <div class="error-message" id="first-name-error"></div>
   <input type="text" id="last-name" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" required aria-label="–ü—Ä—ñ–∑–≤–∏—â–µ" aria-describedby="last-name-error" />
   <div class="error-message" id="last-name-error"></div>
   <input type="email" id="email" placeholder="Email" required aria-label="Email" aria-describedby="email-error" />
   <div class="error-message" id="email-error"></div>
   <div class="password-toggle">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required aria-label="–ü–∞—Ä–æ–ª—å" aria-describedby="password-error" />
    <span id="toggle-password" role="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç–∏ –∞–±–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å">üëÅ</span>
   </div>
   <div class="error-message" id="password-error"></div>
   <div class="password-toggle">
    <input type="password" id="confirm-password" placeholder="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä–æ–ª—å" required aria-label="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä–æ–ª—å" aria-describedby="confirm-password-error" />
    <span id="toggle-confirm" role="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç–∏ –∞–±–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è">üëÅ</span>
   </div>
   <div class="error-message" id="confirm-password-error"></div>
   <input type="text" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+380...)" required aria-label="–¢–µ–ª–µ—Ñ–æ–Ω" aria-describedby="phone-error" />
   <div class="error-message" id="phone-error"></div>
   <input type="date" id="dob" required aria-label="–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è" aria-describedby="dob-error" />
   <div class="error-message" id="dob-error"></div>
   <select id="sex" required aria-label="–°—Ç–∞—Ç—å" aria-describedby="sex-error">
    <option value="">–°—Ç–∞—Ç—å</option>
    <option value="male">–ß–æ–ª–æ–≤—ñ–∫</option>
    <option value="female">–ñ—ñ–Ω–∫–∞</option>
   </select>
   <div class="error-message" id="sex-error"></div>
   <select id="country" required aria-label="–ö—Ä–∞—ó–Ω–∞" aria-describedby="country-error">
    <option value="">–ö—Ä–∞—ó–Ω–∞</option>
    ${countries.map(c => `<option value="${c}">${c}</option>`).join('')}
   </select>
   <div class="error-message" id="country-error"></div>
   <select id="city" disabled required aria-label="–ú—ñ—Å—Ç–æ" aria-describedby="city-error">
    <option value="">–ú—ñ—Å—Ç–æ</option>
   </select>
   <div class="error-message" id="city-error"></div>
   <button type="submit" aria-label="–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
  </form>`;

 const loginForm = document.getElementById('login-form');
 const registerForm = document.getElementById('register-form');
 const toggleLogin = document.getElementById('toggle-login');
 const togglePassword = document.getElementById('toggle-password');
 const toggleConfirm = document.getElementById('toggle-confirm');
 const loginUsername = document.getElementById('login-username');
 const loginPassword = document.getElementById('login-password');
 const firstName = document.getElementById('first-name');
 const lastName = document.getElementById('last-name');
 const email = document.getElementById('email');
 const password = document.getElementById('password');
 const confirmPassword = document.getElementById('confirm-password');
 const phone = document.getElementById('phone');
 const dob = document.getElementById('dob');
 const sex = document.getElementById('sex');
 const country = document.getElementById('country');
 const city = document.getElementById('city');

 const validateOnInput = (field, condition, errorMessage, emptyMessage) => {
  field.addEventListener('input', () => validateField(field, condition, errorMessage, emptyMessage));
  field.addEventListener('change', () => validateField(field, condition, errorMessage, emptyMessage));
 };

 validateOnInput(loginUsername, () => loginUsername.value.length >= 3 && loginUsername.value.length <= 15, '–Ü–º‚Äô—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤');
 validateOnInput(loginPassword, () => loginPassword.value.length >= 6, '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤');
 validateOnInput(firstName, () => firstName.value.length >= 3 && firstName.value.length <= 15, '–Ü–º‚Äô—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤');
 validateOnInput(lastName, () => lastName.value.length >= 3 && lastName.value.length <= 15, '–ü—Ä—ñ–∑–≤–∏—â–µ –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤');
 validateOnInput(email, () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value), '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π email');
 validateOnInput(password, () => password.value.length >= 6, '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤');
 validateOnInput(confirmPassword, () => confirmPassword.value === password.value, '–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è');
 validateOnInput(phone, () => /^\+380\d{9}$/.test(phone.value), '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (+380...)');
 validateOnInput(dob, () => {
  const birthDate = new Date(dob.value);
  const today = new Date();
  const age = today.getFullYear() - birthDate.getFullYear();
  const isValidDate = !isNaN(birthDate);
  const isFuture = birthDate > today;
  const isUnderage = age < 12;
  return isValidDate && !isFuture && !isUnderage;
 }, '–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è');
 validateOnInput(sex, () => sex.value === 'male' || sex.value === 'female', '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—å');
 validateOnInput(country, () => country.value, '–í–∏–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É');
 validateOnInput(city, () => city.value && !city.disabled, '–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ');

 toggleLogin.addEventListener('click', () => {
  loginPassword.type = loginPassword.type === 'password' ? 'text' : 'password';
  toggleLogin.textContent = loginPassword.type === 'password' ? 'üëÅ' : 'üôà';
  toggleLogin.setAttribute('aria-label', loginPassword.type === 'password' ? '–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å' : '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å');
 });

 togglePassword.addEventListener('click', () => {
  password.type = password.type === 'password' ? 'text' : 'password';
  togglePassword.textContent = password.type === 'password' ? 'üëÅ' : 'üôà';
  togglePassword.setAttribute('aria-label', password.type === 'password' ? '–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å' : '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å');
 });

 toggleConfirm.addEventListener('click', () => {
  confirmPassword.type = confirmPassword.type === 'password' ? 'text' : 'password';
  toggleConfirm.textContent = confirmPassword.type === 'password' ? 'üëÅ' : 'üôà';
  toggleConfirm.setAttribute('aria-label', confirmPassword.type === 'password' ? '–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è' : '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è');
 });

 country.addEventListener('change', () => {
  city.disabled = !country.value;
  city.innerHTML = '<option value="">–ú—ñ—Å—Ç–æ</option>';
  if (country.value) {
   cities[country.value].forEach(c => {
    city.innerHTML += `<option value="${c}">${c}</option>`;
   });
  }
  validateField(city, () => city.value && !city.disabled, '–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ');
 });

 loginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const usernameValid = validateField(loginUsername, () => loginUsername.value.length >= 3 && loginUsername.value.length <= 15, '–Ü–º‚Äô—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤');
  const passwordValid = validateField(loginPassword, () => loginPassword.value.length >= 6, '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤');

  if (usernameValid && passwordValid) {
   const users = JSON.parse(localStorage.getItem('users') || '[]');
   const found = users.find(u => u.firstName === loginUsername.value && u.password === loginPassword.value);
   if (found) {
    const remember = document.getElementById('remember-me').checked;
    if (remember) localStorage.setItem('currentUser', `${found.firstName} ${found.lastName}`);
    else sessionStorage.setItem('currentUser', `${found.firstName} ${found.lastName}`);
    showSuccessMessage('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!');
    renderAuth();
   } else {
    loginUsername.nextElementSibling.textContent = '–ù–µ–≤—ñ—Ä–Ω–µ —ñ–º‚Äô—è –∞–±–æ –ø–∞—Ä–æ–ª—å';
    loginUsername.classList.add('invalid');
    loginUsername.setAttribute('aria-invalid', 'true');
    loginUsername.focus();
   }
  } else {
   const firstInvalid = loginForm.querySelector('.invalid');
   if (firstInvalid) firstInvalid.focus();
  }
 });

 registerForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const validations = [
   validateField(firstName, () => firstName.value.length >= 3 && firstName.value.length <= 15, '–Ü–º‚Äô—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤'),
   validateField(lastName, () => lastName.value.length >= 3 && lastName.value.length <= 15, '–ü—Ä—ñ–∑–≤–∏—â–µ –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤'),
   validateField(email, () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value), '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π email'),
   validateField(password, () => password.value.length >= 6, '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤'),
   validateField(confirmPassword, () => confirmPassword.value === password.value, '–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è'),
   validateField(phone, () => /^\+380\d{9}$/.test(phone.value), '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (+380...)'),
   validateField(dob, () => {
    const birthDate = new Date(dob.value);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    const isValidDate = !isNaN(birthDate);
    const isFuture = birthDate > today;
    const isUnderage = age < 12;
    return isValidDate && !isFuture && !isUnderage;
   }, '–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è'),
   validateField(sex, () => sex.value === 'male' || sex.value === 'female', '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—å'),
   validateField(country, () => country.value, '–í–∏–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É'),
   validateField(city, () => city.value && !city.disabled, '–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ')
  ];

  if (validations.every(v => v)) {
   const users = JSON.parse(localStorage.getItem('users') || '[]');
   if (users.some(u => u.email === email.value)) {
    email.nextElementSibling.textContent = '–¶–µ–π email —É–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ';
    email.classList.add('invalid');
    email.setAttribute('aria-invalid', 'true');
    email.focus();
    return;
   }
   if (users.some(u => u.firstName === firstName.value)) {
    firstName.nextElementSibling.textContent = '–¶–µ —ñ–º‚Äô—è —É–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ';
    firstName.classList.add('invalid');
    firstName.setAttribute('aria-invalid', 'true');
    firstName.focus();
    return;
   }
   const user = {
    firstName: firstName.value,
    lastName: lastName.value,
    email: email.value,
    password: password.value,
    phone: phone.value,
    dob: dob.value,
    sex: sex.value,
    country: country.value,
    city: city.value,
    registrationDate: new Date().toISOString()
   };
   users.push(user);
   localStorage.setItem('users', JSON.stringify(users));
   showSuccessMessage('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–∞—à–µ —ñ–º‚Äô—è.');
   registerForm.reset();
   city.disabled = true;
   city.innerHTML = '<option value="">–ú—ñ—Å—Ç–æ</option>';
   showForm('login-form');
  } else {
   const firstInvalid = registerForm.querySelector('.invalid');
   if (firstInvalid) firstInvalid.focus();
  }
 });
};

const logout = () => {
 localStorage.removeItem('currentUser');
 sessionStorage.removeItem('currentUser');
 location.reload();
};

const renderUsers = (users) => {
 usersContainer.innerHTML = '';
 const start = (currentPage - 1) * usersPerPage;
 const paginated = users.slice(start, start + usersPerPage);
 paginated.forEach(user => {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
   <img src="${user.picture?.medium || 'https://via.placeholder.com/100'}" alt="–ê–≤–∞—Ç–∞—Ä ${user.name?.first || user.firstName} ${user.name?.last || user.lastName}" />
   <h3>${user.name?.first || user.firstName} ${user.name?.last || user.lastName}</h3>
   <p>–í—ñ–∫: ${user.dob?.age || Math.floor((new Date() - new Date(user.dob)) / (365.25 * 24 * 60 * 60 * 1000))}</p>
   <p>Email: ${user.email}</p>
   <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${user.phone}</p>
   <p>–ú—ñ—Å—Ç–æ: ${user.city || user.location?.city || '–ù–µ–≤—ñ–¥–æ–º–æ'}</p>
   <button onclick="toggleFavorite('${user.email}')" aria-label="${isFavorite(user.email) ? '–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ' : '–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ'}">${isFavorite(user.email) ? '‚òÖ' : '‚òÜ'} –û–±—Ä–∞–Ω–µ</button>
  `;
  usersContainer.appendChild(card);
 });
 renderPagination(users.length);
};

const renderFavorites = () => {
 favoritesUsers.innerHTML = '';
 const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
 const favoriteUsers = allUsers.filter(user => favorites.includes(user.email));
 if (favoriteUsers.length === 0) {
  favoritesUsers.innerHTML = '<p>–ù–µ–º–∞—î –æ–±—Ä–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>';
 } else {
  favoriteUsers.forEach(user => {
   const card = document.createElement('div');
   card.className = 'card';
   card.innerHTML = `
    <img src="${user.picture?.medium || 'https://via.placeholder.com/100'}" alt="–ê–≤–∞—Ç–∞—Ä ${user.name?.first || user.firstName} ${user.name?.last || user.lastName}" />
    <h3>${user.name?.first || user.firstName} ${user.name?.last || user.lastName}</h3>
    <p>–í—ñ–∫: ${user.dob?.age || Math.floor((new Date() - new Date(user.dob)) / (365.25 * 24 * 60 * 60 * 1000))}</p>
    <p>Email: ${user.email}</p>
    <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${user.phone}</p>
    <p>–ú—ñ—Å—Ç–æ: ${user.city || user.location?.city || '–ù–µ–≤—ñ–¥–æ–º–æ'}</p>
    <button onclick="toggleFavorite('${user.email}'); renderFavorites();" aria-label="${isFavorite(user.email) ? '–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ' : '–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ'}">${isFavorite(user.email) ? '‚òÖ' : '‚òÜ'} –û–±—Ä–∞–Ω–µ</button>
   `;
   favoritesUsers.appendChild(card);
  });
 }
};

const showFavorites = () => {
 usersContainer.classList.add('hidden');
 pagination.classList.add('hidden');
 favoritesSection.classList.remove('hidden');
 renderFavorites();
};

const closeFavorites = () => {
 favoritesSection.classList.add('hidden');
 usersContainer.classList.remove('hidden');
 pagination.classList.remove('hidden');
 renderUsers(filteredUsers);
};

const renderPagination = (total) => {
 const pages = Math.ceil(total / usersPerPage);
 pagination.innerHTML = '';
 for (let i = 1; i <= pages; i++) {
  const btn = document.createElement('button');
  btn.textContent = i;
  btn.setAttribute('aria-label', `–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ${i}`);
  if (i === currentPage) btn.classList.add('active-page');
  btn.onclick = () => {
   currentPage = i;
   renderUsers(filteredUsers);
   updateURL();
  };
  pagination.appendChild(btn);
 }
};

const isFavorite = (email) => {
 const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
 return favorites.includes(email);
};

const toggleFavorite = (email) => {
 let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
 if (favorites.includes(email)) {
  favorites = favorites.filter(f => f !== email);
 } else {
  favorites.push(email);
 }
 localStorage.setItem('favorites', JSON.stringify(favorites));
 renderUsers(filteredUsers);
};

const updateURL = () => {
 const params = new URLSearchParams();
 if (searchInput.value) params.set('search', searchInput.value);
 if (sortSelect.value) params.set('sort', sortSelect.value);
 if (filterAge.value) params.set('age', filterAge.value);
 if (filterLocation.value) params.set('location', filterLocation.value);
 if (currentPage > 1) params.set('page', currentPage);
 history.pushState({}, '', `?${params.toString()}`);
};

const applyFilters = () => {
 let list = [...allUsers];
 const term = searchInput.value.trim().toLowerCase();
 if (term) {
  list = list.filter(u => {
   const firstName = (u.name?.first || u.firstName || '').toLowerCase();
   return firstName.includes(term);
  });
 }
 if (filterAge.value) {
  const [min, max] = filterAge.value.split('-').map(Number);
  list = list.filter(u => {
   const age = u.dob?.age || Math.floor((new Date() - new Date(u.dob)) / (365.25 * 24 * 60 * 60 * 1000));
   return max ? age >= min && age <= max : age >= min;
  });
 }
 if (filterLocation.value) {
  list = list.filter(u => (u.city || u.location?.city || '').toLowerCase().includes(filterLocation.value.toLowerCase()));
 }

 switch (sortSelect.value) {
  case 'name-asc':
   list.sort((a, b) => {
    const nameA = (a.name?.first || a.firstName || '').toLowerCase();
    const nameB = (b.name?.first || b.firstName || '').toLowerCase();
    return nameA.localeCompare(nameB, 'uk');
   });
   break;
  case 'name-desc':
   list.sort((a, b) => {
    const nameA = (a.name?.first || a.firstName || '').toLowerCase();
    const nameB = (b.name?.first || b.firstName || '').toLowerCase();
    return nameB.localeCompare(nameA, 'uk');
   });
   break;
  case 'age-asc':
   list.sort((a, b) => (a.dob?.age || Math.floor((new Date() - new Date(a.dob)) / (365.25 * 24 * 60 * 60 * 1000))) - (b.dob?.age || Math.floor((new Date() - new Date(b.dob)) / (365.25 * 24 * 60 * 60 * 1000))));
   break;
  case 'age-desc':
   list.sort((a, b) => (b.dob?.age || Math.floor((new Date() - new Date(b.dob)) / (365.25 * 24 * 60 * 60 * 1000))) - (a.dob?.age || Math.floor((new Date() - new Date(a.dob)) / (365.25 * 24 * 60 * 60 * 1000))));
   break;
  case 'reg-date-asc':
   list.sort((a, b) => new Date(a.registrationDate || '2000-01-01') - new Date(b.registrationDate || '2000-01-01'));
   break;
  case 'reg-date-desc':
   list.sort((a, b) => new Date(b.registrationDate || '2000-01-01') - new Date(a.registrationDate || '2000-01-01'));
   break;
 }

 filteredUsers = list;
 currentPage = 1;
 renderUsers(filteredUsers);
 updateURL();
};

const fetchUsers = async () => {
 try {
  const res = await fetch('https://randomuser.me/api/?results=100');
  const data = await res.json();
  allUsers = [...data.results, ...JSON.parse(localStorage.getItem('users') || '[]')];
  const params = new URLSearchParams(window.location.search);
  searchInput.value = params.get('search') || '';
  sortSelect.value = params.get('sort') || '';
  filterAge.value = params.get('age') || '';
  filterLocation.value = params.get('location') || '';
  currentPage = parseInt(params.get('page')) || 1;
  applyFilters();
 } catch {
  usersContainer.innerHTML = '<p role="alert">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>';
 }
};

searchInput.addEventListener('input', debounce(applyFilters, 300));
sortSelect.addEventListener('change', applyFilters);
filterAge.addEventListener('change', applyFilters);
filterLocation.addEventListener('input', debounce(applyFilters, 300));

renderAuth();